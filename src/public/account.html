<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Account Details</title>
  <link rel="stylesheet" href="accountstyle.css" />
  <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
  <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
</head>

<body>
  <a href="/" class="homeicon">
    <img alt="Home_Icon" src="./content/homeIconWhite.png">
  </a>

  <div class="mainbggrid">
    <section class="waveanim">
      <div class="wave">
        <span></span><span></span><span></span>
      </div>
    </section>

    <div class="mainfgholder">
      <div class="mainfgupperholder">
        <div class="userinfo">
          <img class="profilepic" src="content/deafult.jpg" alt="profile_pic" style="cursor: pointer;">
          <div class="profilbilgi">
            <p id="authLabel"></p>
            <div class="logged-in-infos">
              <p id="usernameLabel">Username</p>
            </div>
            <div class="wrapper"></div>
          </div>

          <div class="zartzurtbilgi">
            <div class="zartzurtbilgibox">
              <h3>Join Date</h3>
              <p id="joindatecontent">-</p>
            </div>
            <div class="zartzurtbilgibox">
              <h3>Verified</h3>
              <p id="verificationcontent">-</p>
            </div>
            <div class="zartzurtbilgibox">
              <h3>Role</h3>
              <p id="rolecontent">-</p>
            </div>
            <div class="zartzurtbilgibox" id="zartzurtbilgitel">
              <h3 style="grid-area: head;">Contact</h3>
              <p style="grid-area: content;" id="contactcontent">-</p>
              <div style="grid-area: edit;" id="emailEditIcon" class="editimgholder">
                <img class="editimg" src="/content/editIconWhite.png" alt="Edit">
              </div>
            </div>
          </div>
        </div>

        <div class="maintitleholder">
          <p style="font-size: 3.5em; font-weight: 200">Hello,</p>
          <p id="realnameLabel"
            style="font-size: 4.5em; font-weight: 400; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">
            Real Name</p>
          <p style="font-size: 1em; font-weight: 400">Built By: Onur Dönmez</p>
        </div>
      </div>

      <div class="mainfglowerholder">
        <div data-aos="fade-up" class="routeoption" id="changeAvatarBtn">
          <h1>Update My Profile Pic</h1>
        </div>
        <div data-aos="fade-up" class="routeoption" id="settingsButton">
          <h1>Settings</h1>
        </div>
        <div data-aos="fade-up" class="routeoption" id="adminPanelBtn" style="display: none;">
          <h1>Admin Panel</h1>
        </div>
        <div data-aos="fade-up" class="routeoption" id="logoutholder">
          <h1 id="logoutButton">Log Out</h1>
        </div>
      </div>
    </div>
  </div>

  <div id="profileModal" hidden>
    <div class="pm-backdrop"></div>
    <div class="pm-dialog">
      <div class="pm-head">
        <h2 id="pm-title">Choose a profile picture</h2>
        <button class="pm-close">✕</button>
      </div>
      <div id="pm-content" class="pm-content" style="padding:0; height:100%;">
        <div class="pm-loading">Loading Collections...</div>
      </div>
    </div>
  </div>

  <div id="settingsModal" hidden>
    <div class="pm-backdrop"></div>
    <div class="pm-dialog settings-dialog">
      <div class="pm-head">
        <h2>Settings</h2><button class="pm-close">✕</button>
      </div>
      <div class="pm-content">
        <div class="st-section">
          <h3 class="st-heading">Account Identity</h3>
          <div class="st-row column">
            <span class="st-label">Email</span>
            <div class="st-input-group">
              <input type="text" id="newEmail" class="st-input" placeholder="New Email">
              <button class="st-save-btn" id="updateEmaileBtn">Update</button>
            </div>
          </div>
        </div>
        <div class="st-section">
          <h3 class="st-heading">Security</h3>
          <div class="st-row column">
            <span class="st-label">New Password</span>
            <div class="st-input-group">
              <input type="password" id="newPassword" class="st-input" placeholder="New Password">
              <button class="st-save-btn" id="updatePasswordBtn">Change</button>
            </div>
          </div>
        </div>

        <hr class="st-divider">

        <div class="st-section">
          <h3 class="st-heading">Global Channels</h3>
          <div class="st-row">
            <div class="st-info"><span class="st-label">Push Notifications</span></div>
            <label class="switch"><input type="checkbox" id="push_enabled"><span class="slider round"></span></label>
          </div>
          <div class="st-row">
            <div class="st-info"><span class="st-label">Email Notifications</span></div>
            <label class="switch"><input type="checkbox" id="email_enabled"><span class="slider round"></span></label>
          </div>
        </div>

        <hr class="st-divider">

        <div class="st-section">
          <h3 class="st-heading">Push Alerts (App)</h3>
          <div class="st-list">
            <div class="st-row compact"><div class="st-info"><span class="st-label">Login Event</span></div><label class="switch small"><input type="checkbox" id="push_login"><span class="slider round"></span></label></div>
            <div class="st-row compact"><div class="st-info"><span class="st-label">Public Post Created</span></div><label class="switch small"><input type="checkbox" id="push_public_share"><span class="slider round"></span></label></div>
            <div class="st-row compact"><div class="st-info"><span class="st-label">Private Post Sent to You</span></div><label class="switch small"><input type="checkbox" id="push_direct_share"><span class="slider round"></span></label></div>
            <div class="st-row compact"><div class="st-info"><span class="st-label">Comments</span></div><label class="switch small"><input type="checkbox" id="push_post_comment"><span class="slider round"></span></label></div>
            <div class="st-row compact"><div class="st-info"><span class="st-label">Reactions</span></div><label class="switch small"><input type="checkbox" id="push_post_reaction"><span class="slider round"></span></label></div>
            <div class="st-row compact"><div class="st-info"><span class="st-label">Song Played</span></div><label class="switch small"><input type="checkbox" id="push_song_played"><span class="slider round"></span></label></div>
          </div>
        </div>

        <hr class="st-divider">

        <div class="st-section">
          <h3 class="st-heading">Email Alerts</h3>
          <div class="st-list">
            <div class="st-row compact"><div class="st-info"><span class="st-label">Login Event</span></div><label class="switch small"><input type="checkbox" id="email_login"><span class="slider round"></span></label></div>
            <div class="st-row compact"><div class="st-info"><span class="st-label">Public Post Created</span></div><label class="switch small"><input type="checkbox" id="email_public_share"><span class="slider round"></span></label></div>
            <div class="st-row compact"><div class="st-info"><span class="st-label">Private Post Sent to You</span></div><label class="switch small"><input type="checkbox" id="email_direct_share"><span class="slider round"></span></label></div>
            <div class="st-row compact"><div class="st-info"><span class="st-label">Comments</span></div><label class="switch small"><input type="checkbox" id="email_post_comment"><span class="slider round"></span></label></div>
            <div class="st-row compact"><div class="st-info"><span class="st-label">Reactions</span></div><label class="switch small"><input type="checkbox" id="email_post_reaction"><span class="slider round"></span></label></div>
            <div class="st-row compact"><div class="st-info"><span class="st-label">Song Played</span></div><label class="switch small"><input type="checkbox" id="email_song_played"><span class="slider round"></span></label></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    AOS.init();
    let avatarData = [];

    // --- 1. Load User Profile ---
    async function loadProfile() {
      try {
        const res = await fetch("/meinfo", { credentials: "include" });
        if (!res.ok) return window.location.href = "/login";
        const profile = await res.json();

        document.getElementById("usernameLabel").innerText = profile.username;
        document.getElementById("rolecontent").innerText = profile.role;
        document.getElementById("verificationcontent").innerText = profile.email_verified ? "Verified" : "NOT Verified";
        document.getElementById("contactcontent").innerText = `${profile.email || 'No Email'} | ${profile.phone || 'No Tel'}`;
        document.getElementById("realnameLabel").innerText = profile.realName || "No Name Set";
        document.getElementById("joindatecontent").innerText = profile.joinDate ? new Date(profile.joinDate).toLocaleDateString() : "-";

        const pic = document.querySelector('.profilepic');
        pic.src = profile.profilePic ? `/media/${profile.profilePic}` : 'content/deafult.jpg';

        if (profile.role?.toLowerCase().includes('admin')) {
          document.getElementById('adminPanelBtn').style.display = 'block';
        }

        loadNotificationSettings();
      } catch (err) { console.error(err); }
    }

    // --- 2. Load Notifications (with Admin Lock & Mobile Check) ---
    async function loadNotificationSettings() {
      try {
        const [settingsRes, globalRes, pushStatusRes] = await Promise.all([
          fetch("/api/me/notifications"),
          fetch("/api/notifications/global-status"),
          fetch("/api/me/push-subscription-status")
        ]);

        if (!settingsRes.ok || !globalRes.ok || !pushStatusRes.ok) return;

        const settings = await settingsRes.json();
        const globalStatus = await globalRes.json();
        const { hasSubscription } = await pushStatusRes.json();

        // Database column keys
        const columns = [
          'push_enabled', 'email_enabled',
          'push_login', 'push_public_share', 'push_direct_share', 'push_post_comment', 'push_post_reaction', 'push_song_played',
          'email_login', 'email_public_share', 'email_direct_share', 'email_post_comment', 'email_post_reaction', 'email_song_played'
        ];

        columns.forEach(col => {
          const checkbox = document.getElementById(col);
          if (!checkbox) return;

          checkbox.checked = settings[col];
          checkbox.disabled = false;
          const row = checkbox.closest('.st-row') || checkbox.closest('.compact');
          row.querySelectorAll('.admin-warning').forEach(w => w.remove());

          const systemMaster = col.startsWith('email') ? 'email_system_master' : 'push_system_master';
          let reason = null;

          // Hierarchy: Global Admin Switch > Category Switch > Mobile Registration
          if (globalStatus[systemMaster] === false) reason = '⚠️ System disabled by Admin';
          else if (globalStatus[col] === false) reason = '⚠️ Category disabled by Admin';
          else if (col.startsWith('push') && !hasSubscription) reason = '⚠️ No mobile device registered';

          if (reason) {
            checkbox.disabled = true;
            const warning = document.createElement('small');
            warning.className = 'admin-warning';
            warning.style.cssText = 'color: #e74c3c; font-size: 0.75rem; display: block;';
            warning.innerText = reason;
            row.querySelector('.st-info').appendChild(warning);
          }
        });
      } catch (err) { console.error(err); }
    }

    // --- 3. Modern Avatar Sidebar Selector ---
    async function openAvatarSelector() {
      const profileModal = document.getElementById('profileModal');
      const pmContent = document.getElementById('pm-content');
      profileModal.hidden = false;
      document.documentElement.classList.add('no-scroll');

      try {
        const res = await fetch('/api/avatars', { credentials: 'include' });
        const data = await res.json();
        avatarData = data.people || [];

        pmContent.innerHTML = `
          <div class="pm-layout">
            <aside class="pm-sidebar" id="pmSidebar"></aside>
            <main class="pm-main-content" id="pmMain"></main>
          </div>`;

        const sidebar = document.getElementById('pmSidebar');
        avatarData.forEach((person, idx) => {
          const btn = document.createElement('button');
          btn.className = `category-btn ${idx === 0 ? 'active' : ''}`;
          btn.innerText = person.name;
          btn.onclick = () => {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCategory(person.name);
          };
          sidebar.appendChild(btn);
        });
        if (avatarData.length) renderCategory(avatarData[0].name);
      } catch (err) { pmContent.innerText = "Failed to load avatars."; }
    }

    function renderCategory(name) {
      const main = document.getElementById('pmMain');
      const person = avatarData.find(p => p.name === name);
      main.innerHTML = `<div class="pm-grid"></div>`;
      const grid = main.querySelector('.pm-grid');

      person.images.forEach(img => {
        const card = document.createElement('button');
        card.className = 'pm-pick';
        card.innerHTML = `
          <div class="skeleton-container skeleton"><img src="${img.url}" loading="lazy" onload="this.parentElement.classList.remove('skeleton')"></div>
          <small>${img.file}</small>`;
        card.onclick = () => selectAvatar(img.url);
        grid.appendChild(card);
      });
    }

    async function selectAvatar(url) {
      const rel = url.replace('/media/', '');
      try {
        const res = await fetch('/api/me/profile-picture', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: rel })
        });
        if (res.ok) {
          document.querySelector('.profilepic').src = url;
          document.getElementById('profileModal').hidden = true;
          document.documentElement.classList.remove('no-scroll');
        }
      } catch (err) { alert("Update failed"); }
    }

    // --- 4. Interactions & Listeners ---
    document.getElementById('changeAvatarBtn').onclick = openAvatarSelector;
    document.querySelector('.profilepic').onclick = openAvatarSelector;

    document.getElementById('settingsButton').onclick = () => {
      document.getElementById('settingsModal').hidden = false;
      document.documentElement.classList.add('no-scroll');
    };

    document.getElementById('emailEditIcon').onclick = () => {
      document.getElementById('settingsModal').hidden = false;
      document.documentElement.classList.add('no-scroll');
    };

    document.querySelectorAll('.pm-close, .pm-backdrop').forEach(el => {
      el.onclick = () => {
        document.querySelectorAll('#profileModal, #settingsModal').forEach(m => m.hidden = true);
        document.documentElement.classList.remove('no-scroll');
      };
    });

    // Notify backend on toggle change
    document.querySelector('#settingsModal').addEventListener('change', (e) => {
      if (e.target.type === 'checkbox') {
        fetch("/api/me/notifications", {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ [e.target.id]: e.target.checked })
        });
      }
    });

    // Update Email and Password Handlers
    document.getElementById('updateEmaileBtn').onclick = async () => {
      const newEmail = document.getElementById('newEmail').value;
      const res = await fetch('/api/me/update-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newEmail })
      });
      if (res.ok) { alert("Email updated! Check your inbox."); location.reload(); }
    };

    document.getElementById('updatePasswordBtn').onclick = async () => {
      const password = document.getElementById('newPassword').value;
      const res = await fetch('/api/me/update-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      if (res.ok) { alert("Password changed!"); document.getElementById('newPassword').value = ''; }
    };

    document.getElementById('logoutholder').onclick = async () => {
      await fetch('/logout', { method: 'POST' });
      window.location.href = '/login';
    };

    document.getElementById('adminPanelBtn').onclick = () => {
      window.location.href = '/admin';
    };

    // Initialize Page
    loadProfile();

    const mq = window.matchMedia("(min-width: 800px)");
    if (mq.matches) {
        // 1. remove data-aos attributes so AOS won't animate
        document.querySelectorAll("[data-aos]").forEach(el => {
            el.removeAttribute("data-aos");
            el.style.opacity = ""; // optional: let it use normal styles
            el.style.transform = ""; // optional cleanup in case AOS touched it
        });

        // 2. stop AOS from doing anything else
        AOS.refreshHard = () => { };
        AOS.init = () => { };
    }
  </script>
</body>
</html>