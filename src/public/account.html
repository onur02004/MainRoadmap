<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Account Details</title>
  <link rel="stylesheet" href="accountstyle.css" />

  <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
  <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

</head>

<body>
  <a href="/" class="homeicon">
    <img alt="Home_Icon" src="./content/homeIconWhite.png">
  </a>

  <div class="mainbggrid">
    <section class="waveanim">
      <div class="wave">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </section>

    <div class="mainfgholder">

      <div class="mainfgupperholder">



        <div class="userinfo">
          <img class="profilepic" src="content/deafult.jpg" alt="profile_pic">


          <div class="profilbilgi">
            <p id="authLabel"></p>
            <div class="logged-in-infos">
              <p id="usernameLabel">Username</p>
            </div>



            <div class="wrapper"></div>
          </div>

          <div class="zartzurtbilgi">
            <div class="zartzurtbilgibox">
              <h3>Join Date</h3>
              <p id="joindatecontent">Join date Content</p>
            </div>

            <div class="zartzurtbilgibox">
              <h3>Verified</h3>
              <p id="verificationcontent">Verification Content</p>
            </div>

            <div class="zartzurtbilgibox">
              <h3>Role</h3>
              <p id="rolecontent">Role Content</p>
            </div>

            <div class="zartzurtbilgibox" id="zartzurtbilgitel">
              <h3 style="grid-area: head;">Contact</h3>
              <p style="grid-area: content;" id="contactcontent">Email / Tel Content</p>
              <div style="grid-area: edit;" class="editimgholder">
                <img class="editimg" src="/content/editIconWhite.png" alt="Edit">
              </div>
            </div>

          </div>

        </div>

        <div class="maintitleholder">
          <p style="font-size: 3.5em; font-weight: 200">Hello,</p>
          <p id="realnameLabel"
            style="font-size: 4.5em; font-weight: 400; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">
            Real Name</p>
          <p style="font-size: 1em; font-weight: 400">
            Built By: Onur Dönmez
          </p>
        </div>

      </div>

      <div class="mainfglowerholder">
        <div data-aos="fade-up" class="routeoption" id="changeAvatarBtn">
          <h1>Update My Profile Pic</h1>
        </div>

        <div data-aos="fade-up" class="routeoption" notavailable>
          <h1>My Images</h1>
        </div>

        <div data-aos="fade-up" class="routeoption" notavailable>
          <h1>Relations</h1>
        </div>

        <div data-aos="fade-up" class="routeoption" id="settingsButton">
          <h1>Settings</h1>
        </div>

        <div data-aos="fade-up" class="routeoption" id="adminPanelBtn" style="display: none;">
          <h1>Admin Panel</h1>
        </div>

        <div data-aos="fade-up" class="routeoption" id="logoutholder">
          <h1 id="logoutButton">Log Out</h1>
        </div>


      </div>

    </div>
  </div>

  <!-- Profile / Avatar modal -->
  <div id="profileModal" hidden>
    <div class="pm-backdrop"></div>
    <div class="pm-dialog" role="dialog" aria-modal="true" aria-labelledby="pm-title">
      <div class="pm-head">
        <h2 id="pm-title">Choose a profile picture</h2>
        <button class="pm-close" type="button" aria-label="Close">✕</button>
      </div>
      <div id="pm-content" class="pm-content">
        <!-- avatars grid will be injected here -->
        <div class="pm-loading">Loading…</div>
      </div>
    </div>
  </div>

  <div id="settingsModal" hidden>
    <div class="pm-backdrop"></div>
    <div class="pm-dialog settings-dialog" role="dialog" aria-modal="true">
      <div class="pm-head">
        <h2 id="sm-title">Settings</h2>
        <button class="pm-close" type="button" aria-label="Close">✕</button>
      </div>

      <div class="pm-content">

        <div class="st-section">
          <h3 class="st-heading">Notification Channels</h3>
          <p class="st-desc">Choose how you want to be notified.</p>

          <div class="st-row">
            <div class="st-info">
              <span class="st-label">Push Notifications</span>
              <small class="st-sub">
                Android Mobile Only. <br>
                Enable system-level alerts on your device.
              </small>
            </div>
            <label class="switch">
              <input type="checkbox" id="togglePush" disabled>
              <span class="slider round"></span>
            </label>
          </div>

          <div class="st-row">
            <div class="st-info">
              <span class="st-label">Email Notifications</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="toggleEmail" disabled>
              <span class="slider round"></span>
            </label>
          </div>
        </div>

        <hr class="st-divider">

        <div class="st-section">
          <h3 class="st-heading">Notification Categories</h3>
          <p class="st-desc">Select which activities trigger a notification.</p>


          <div class="st-list">
            <div class="st-row compact">
              <span class="st-label">Login Event</span>
              <label class="switch small">
                <input type="checkbox" checked>
                <span class="slider round"></span>
              </label>
            </div>
            <div class="st-row compact">
              <span class="st-label">Public Song Shared</span>
              <label class="switch small">
                <input type="checkbox" checked>
                <span class="slider round"></span>
              </label>
            </div>
            <div class="st-row compact">
              <span class="st-label">Private Song Sent To You</span>
              <label class="switch small">
                <input type="checkbox" checked>
                <span class="slider round"></span>
              </label>
            </div>
            <div class="st-row compact">
              <span class="st-label">Someone Commented on Your Song Suggestion</span>
              <label class="switch small">
                <input type="checkbox" checked>
                <span class="slider round"></span>
              </label>
            </div>
            <div class="st-row compact">
              <span class="st-label">Someone Reacted on Your Song Suggestion</span>
              <label class="switch small">
                <input type="checkbox" checked>
                <span class="slider round"></span>
              </label>
            </div>
            <div class="st-row compact">
              <span class="st-label">Your Suggested Song Has Been Played</span>
              <label class="switch small">
                <input type="checkbox">
                <span class="slider round"></span>
              </label>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    AOS.init();

    const mq = window.matchMedia("(min-width: 800px)");
    if (mq.matches) {
      document.querySelectorAll("[data-aos]").forEach(el => {
        el.removeAttribute("data-aos");
        el.style.opacity = "";
        el.style.transform = "";
      });

      AOS.refreshHard = () => { };
      AOS.init = () => { };
    }

    document.querySelector('#logoutholder').addEventListener('click', () => {
      handleLogout();
    });

    async function handleLogout() {
      const button = document.getElementById('logoutButton');
      console.log("loggin out bi sn..");

      const originalText = button.textContent;
      button.textContent = 'Logging out...';
      button.disabled = true;
      button.classList.add('opacity-70', 'cursor-not-allowed');

      try {
        const response = await fetch('/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // You might include an Authorization header here if needed (e.g., JWT)
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({})
        });

        if (response.ok) { // This will now catch the 204 No Content
          showMessage('Logout successful. Redirecting...', 'success');
          localStorage.removeItem('token');
          window.location.href = '/login'; // Redirect on the client
        }
        else if (response.status === 401) {
          showMessage('Session expired. Logout forced.', 'info');
          window.location.href = '/login';
        }
        else {
          const errorData = await response.json().catch(() => ({ message: 'Server error occurred.' }));
          showMessage(`Logout failed: ${errorData.message || response.statusText}`, 'error');
        }

      } catch (error) {
        // Handle network errors (e.g., server offline, CORS issues)
        console.error('Network Error during logout:', error);
        showMessage('Network error. Could not reach server.', 'error');
      }
    }


    function showMessage(message, type = 'info') {
      console.log("showMessage(): ", message);
    }


    async function loadProfile() {
      try {
        const res = await fetch("/meinfo", {
          method: "GET",
          credentials: "include"
        });

        if (!res.ok) {
          // e.g. 401, 404, 500...
          console.error("Profile fetch failed:", res.status);
          if (res.status === 401) {
            // not logged in -> back to login
            window.location.href = "/login";
          }
          return;
        }

        const profile = await res.json();
        console.log("profile:", profile);

        // Example: fill DOM
        document.getElementById("usernameLabel").innerHTML = profile.username;

        document.getElementById("rolecontent").innerHTML = profile.role;
        document.getElementById("verificationcontent").innerHTML = profile.verified || "NOT Verified";
        document.getElementById("contactcontent").innerHTML = profile.email + " | " + profile.phone;
        document.getElementById("realnameLabel").innerHTML = profile.realName;

        const joinDateText = profile.joinDate
          ? new Date(profile.joinDate).toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "numeric"
          })
          : "-";
        document.getElementById("joindatecontent").textContent = joinDateText;

        const me = await fetch('/meinfo', { credentials: 'include' }).then(r => r.json());
        const pic = document.querySelector('.profilepic');
        if (pic) {
          if (me.profilePic) pic.src = `/media/${me.profilePic}`;
          else pic.src = 'content/deafult.jpg';
        }

        if (profile.role && profile.role.toLowerCase().includes('admin')) {
          const adminBtn = document.getElementById('adminPanelBtn');
          if (adminBtn) {
            // Make the button visible
            adminBtn.style.display = 'block';

            // Add navigation functionality
            adminBtn.addEventListener('click', () => {
              window.location.href = '/admin'; // Redirect to your admin route
            });
          }
        }
      } catch (err) {
        console.error("Failed to load profile:", err);
      }
    }

    loadProfile();

  </script>

  <script>
    // Utility: open/close modal
    const profileModal = document.getElementById('profileModal');
    const pmContent = document.getElementById('pm-content');
    const pmCloseBtn = profileModal.querySelector('.pm-close');
    const openProfileModal = () => { profileModal.hidden = false; document.documentElement.classList.add('no-scroll'); };
    const closeProfileModal = () => { profileModal.hidden = true; document.documentElement.classList.remove('no-scroll'); };

    // Close interactions
    pmCloseBtn.addEventListener('click', closeProfileModal);
    profileModal.querySelector('.pm-backdrop').addEventListener('click', closeProfileModal);
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !profileModal.hidden) closeProfileModal(); });


    document.getElementById('changeAvatarBtn').addEventListener('click', changeAvatar);
    document.querySelector('.profilepic').addEventListener('click', changeAvatar);

    let avatarData = []; // Store fetched data globally

    async function changeAvatar() {
      openProfileModal();
      pmContent.innerHTML = '<div class="pm-loading">Loading Collections...</div>';

      try {
        const res = await fetch('/api/avatars', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load');
        const { people = [] } = await res.json();
        avatarData = people;

        if (!avatarData.length) {
          pmContent.innerHTML = '<p class="pm-hint">No avatars found.</p>';
          return;
        }

        renderModernLayout();
      } catch (err) {
        console.error(err);
        pmContent.innerHTML = '<p class="pm-hint">Could not load avatars.</p>';
      }
    }

    function renderModernLayout() {
      // Create the split-screen structure
      pmContent.innerHTML = `
    <div class="pm-layout">
      <aside class="pm-sidebar" id="pmSidebar"></aside>
      <main class="pm-main-content" id="pmMain"></main>
    </div>
  `;

      const sidebar = document.getElementById('pmSidebar');

      avatarData.forEach((person, index) => {
        const btn = document.createElement('button');
        btn.className = `category-btn ${index === 0 ? 'active' : ''}`;
        btn.innerText = person.name;
        btn.onclick = () => {
          // Update Active State
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderCategory(person.name);
        };
        sidebar.appendChild(btn);
      });

      // Render the first category by default
      renderCategory(avatarData[0].name);
    }

    function renderCategory(name) {
      const main = document.getElementById('pmMain');
      const person = avatarData.find(p => p.name === name);

      main.innerHTML = `<div class="pm-grid" id="activeGrid"></div>`;
      const grid = document.getElementById('activeGrid');

      if (!person || !person.images.length) {
        grid.innerHTML = '<p>No images in this collection.</p>';
        return;
      }

      person.images.forEach(img => {
        const card = document.createElement('button');
        card.className = 'pm-pick';

        // Modern Image Loading with Placeholder
        card.innerHTML = `
      <div class="skeleton-container">
        <img src="${img.url}" loading="lazy" alt="" onload="this.parentElement.classList.remove('skeleton')">
      </div>
      <small>${escapeHtml(img.file)}</small>
    `;

        card.querySelector('.skeleton-container').classList.add('skeleton');
        card.onclick = () => selectAvatar(img);
        grid.appendChild(card);
      });
    }

    function switchCategory(name, activeBtn) {
      if (activeBtn) {
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        activeBtn.classList.add('active');
      }

      const main = document.getElementById('pmMain');
      const person = avatarCollections.find(p => p.name === name);

      main.innerHTML = `<div class="pm-grid" id="avatarGrid"></div>`;
      const grid = document.getElementById('avatarGrid');

      person.images.forEach(img => {
        const item = document.createElement('div');
        item.className = 'pm-pick skeleton'; // Start with skeleton state

        const imageObj = new Image();
        imageObj.src = img.url;
        imageObj.loading = "lazy"; // Browser native lazy load

        imageObj.onload = () => {
          item.classList.remove('skeleton');
          item.innerHTML = `
                <img src="${img.url}" alt="">
                <small>${escapeHtml(img.file)}</small>
            `;
        };

        item.onclick = () => selectAvatar(img);
        grid.appendChild(item);
      });
    }

    async function selectAvatar(img) {
      // Persist choice
      const rel = img.url.replace(/^\/media\//, ''); // "avatars/…"
      try {
        const res = await fetch('/api/me/profile-picture', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: rel })
        });
        if (!res.ok) throw new Error(await res.text());

        // Update the visible avatar immediately
        const pic = document.querySelector('.profilepic');
        if (pic) pic.src = img.url + '?t=' + Date.now(); // cache-bust

        // Nice little feedback
        pmContent.scrollTo({ top: 0, behavior: 'smooth' });
        const msg = document.createElement('div');
        msg.className = 'pm-row';
        msg.innerHTML = `<span class="pm-hint">✅ Profile picture updated.</span>`;
        pmContent.prepend(msg);

        // Close after a short pause
        setTimeout(closeProfileModal, 600);
      } catch (e) {
        console.error(e);
        alert('Failed to update your profile picture.');
      }
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
  </script>

  <script>
    // --- Settings Modal Logic ---
    const settingsModal = document.getElementById('settingsModal');
    const settingsBtn = document.getElementById('settingsButton');
    const smCloseBtn = settingsModal.querySelector('.pm-close');
    const smBackdrop = settingsModal.querySelector('.pm-backdrop');

    // Functions to open/close
    const openSettingsModal = () => {
      settingsModal.hidden = false;
      document.documentElement.classList.add('no-scroll');
    };

    const closeSettingsModal = () => {
      settingsModal.hidden = true;
      document.documentElement.classList.remove('no-scroll');
    };

    // Event Listeners
    if (settingsBtn) {
      settingsBtn.addEventListener('click', openSettingsModal);
    }

    smCloseBtn.addEventListener('click', closeSettingsModal);
    smBackdrop.addEventListener('click', closeSettingsModal);

    // Close on Escape key (shared logic)
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !settingsModal.hidden) closeSettingsModal();
    });
  </script>

</body>

</html>