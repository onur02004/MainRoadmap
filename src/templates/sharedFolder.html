<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared: {{FOLDER_NAME}}</title>
    <link rel="stylesheet" href="/filesstyle.css">
    <link rel="stylesheet" href="/accountstyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .userinfo {
            justify-content: center;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .profilbilgi {
            display: none;
        }

        .storage-toolbar {
            margin-top: 20px;
        }

        .btn-download-small {
            background: rgba(82, 196, 113, 0.2);
            border: 1px solid #52c471;
            color: #fff;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8em;
            text-decoration: none;
            margin-left: 10px;
        }

        .btn-download-small:hover {
            background: rgba(82, 196, 113, 0.4);
        }

        .preview-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            z-index: 10;
        }

        .close-btn:hover {
            opacity: 1;
        }

        /* --- Navigation Arrows --- */
        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: rgba(82, 196, 113, 0.8);
            transform: translateY(-50%) scale(1.1);
        }

        .prev-btn {
            left: 20px;
        }

        .next-btn {
            right: 20px;
        }

        /* Hide nav buttons on small screens if needed, or adjust position */
        @media (max-width: 900px) {
            .nav-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            .prev-btn { left: 10px; }
            .next-btn { right: 10px; }
        }

        .preview-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            overflow: hidden;
            min-height: 150px;
        }

        .preview-media {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 8px;
        }

        .preview-pdf {
            width: 100%;
            height: 60vh;
            border: none;
            background: #fff;
        }

        .preview-icon {
            font-size: 80px;
            color: #52c471;
            margin: 40px 0;
        }

        .modal-filename {
            font-size: 1.2rem;
            margin-bottom: 20px;
            text-align: center;
            word-break: break-all;
            color: white;
            padding: 0 40px; /* space for close button */
        }

        .btn-download-large {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #52c471;
            color: #fff;
            padding: 12px 32px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            transition: transform 0.2s;
        }

        .btn-download-large:hover {
            transform: scale(1.05);
            background: #45b061;
        }

        .homeicon {
            position: absolute;
            top: 15px;
            z-index: 1000000;
            margin: 1rem;
            background-color: #1313133a;
            border-radius: 10px;
            padding: .7rem;
            margin-bottom: 10px;

            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .homeicon:hover {
            transform: scale(1.05);
        }

        .homeicon img {
            width: 2rem;
        }
    </style>
</head>

<body>
    <a href="/" class="homeicon">
        <img alt="Home_Icon" src="../content/homeIconWhite.png">
    </a>

    <div class="mainbggrid">
        <section class="waveanim">
            <div class="wave"><span></span><span></span><span></span></div>
        </section>

        <div class="mainfgholder">
            <div class="mainfgupperholder">
                <div class="userinfo">
                    <div style="font-size: 3rem; color: #52c471;">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div style="font-size: 0.9em; color: rgba(255,255,255,0.7);">
                        Shared by <span style="color: #52c471; font-weight: bold;">{{OWNER_NAME}}</span>
                    </div>
                </div>
                <div class="maintitleholder" style="text-align: center;">
                    <p id="folderTitleLabel"
                        style="font-size: 3em; font-weight: 400; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                        {{FOLDER_NAME}}
                    </p>
                    <p style="font-size: 1em; font-weight: 400">Shared Folder</p>
                </div>
            </div>

            <div class="mainfglowerholder">
                <div class="storage-toolbar">
                    <div id="storageBreadcrumbs" class="breadcrumbs"></div>
                </div>
                <div id="storageList" class="storage-list"></div>
                <div id="errorMsg" style="text-align:center; padding: 20px; color: #ff5050;"></div>
            </div>
        </div>
    </div>

    <div id="previewModal" class="preview-modal">
        <button class="nav-btn prev-btn" onclick="navigate(-1)">&#10094;</button>
        <button class="nav-btn next-btn" onclick="navigate(1)">&#10095;</button>

        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <h3 id="modalFileName" class="modal-filename">Filename.jpg</h3>
            <div id="previewContainer" class="preview-container"></div>
            <a id="modalDownloadBtn" href="#" class="btn-download-large"><i class="fas fa-download"></i> Download
                File</a>
        </div>
    </div>

    <script>
        const token = "{{TOKEN}}";
        const listEl = document.getElementById('storageList');
        const breadcrumbsEl = document.getElementById('storageBreadcrumbs');
        const titleEl = document.getElementById('folderTitleLabel');
        const errorEl = document.getElementById('errorMsg');

        const modal = document.getElementById('previewModal');
        const modalTitle = document.getElementById('modalFileName');
        const modalContainer = document.getElementById('previewContainer');
        const modalDownloadBtn = document.getElementById('modalDownloadBtn');

        let stack = [];
        let previewableItems = []; // List of files only, for cycling
        let currentPreviewIndex = -1;

        function fmtSize(n) {
            if (n == null) return "";
            const u = ["B", "KB", "MB", "GB"]; let i = 0; let v = Number(n);
            while (v >= 1024 && i < u.length - 1) { v /= 1024; i++; }
            return (i === 0 ? v : v.toFixed(1)) + " " + u[i];
        }

        async function load(folderId) {
            const url = new URL('/api/public-share/' + token + '/list', location.origin);
            if (folderId) url.searchParams.set('folderId', folderId);

            try {
                const r = await fetch(url);
                const j = await r.json();

                if (!r.ok) {
                    listEl.innerHTML = '';
                    errorEl.textContent = j.error || 'Error loading content';
                    return;
                }

                titleEl.textContent = j.folder.name;
                
                // Store files for navigation (exclude folders)
                previewableItems = j.items.filter(item => !item.is_folder);
                
                renderBreadcrumbs();

                listEl.innerHTML = '';
                if (j.items.length === 0) {
                    listEl.innerHTML = '<div style="padding:20px; text-align:center; opacity: 0.6;">Empty folder</div>';
                }

                for (const it of j.items) {
                    const row = document.createElement('div');
                    row.className = 'storage-row';

                    const icon = it.is_folder ? "üìÅ" : "üìÑ";
                    const meta = it.is_folder ? "Folder" : fmtSize(it.size_bytes);

                    row.innerHTML = `
              <div class="storage-left">
                <div class="storage-icon">${icon}</div>
                <div class="storage-name" title="${it.name}">${it.name}</div>
              </div>
              <div class="storage-meta">
                ${meta}
                ${!it.is_folder ? `<a href="/api/public-share/${token}/file/${it.id}" class="btn-download-small" target="_blank" onclick="event.stopPropagation()">Download</a>` : ''}
              </div>
            `;

                    row.onclick = () => {
                        if (it.is_folder) {
                            stack.push({ id: it.id, name: it.name });
                            load(it.id);
                        } else {
                            openPreview(it);
                        }
                    };
                    listEl.appendChild(row);
                }
            } catch (e) {
                errorEl.textContent = "Connection failed";
            }
        }

        function openPreview(item) {
            // Find index in the previewable list
            currentPreviewIndex = previewableItems.findIndex(i => i.id === item.id);

            modalTitle.textContent = item.name;
            const fileUrl = `/api/public-share/${token}/file/${item.id}`;
            const previewUrl = fileUrl + '?preview=1';
            const mime = item.mime_type || '';

            modalDownloadBtn.href = fileUrl;

            let html = '';
            if (mime.startsWith('image/')) {
                html = `<img src="${previewUrl}" class="preview-media" alt="Preview">`;
            } else if (mime.startsWith('video/')) {
                html = `<video controls src="${previewUrl}" class="preview-media" autoplay muted></video>`;
            } else if (mime.startsWith('audio/')) {
                html = `<audio controls src="${previewUrl}" style="width:100%"></audio>`;
            } else if (mime === 'application/pdf') {
                html = `<iframe src="${previewUrl}" class="preview-pdf"></iframe>`;
            } else {
                html = `<div class="preview-icon"><i class="fas fa-file-alt"></i></div><p style="opacity:0.6">Preview not available</p>`;
            }

            modalContainer.innerHTML = html;
            modal.style.display = 'flex';
        }

        function navigate(direction) {
            if (previewableItems.length === 0) return;

            let newIndex = currentPreviewIndex + direction;

            // Cycle logic (Infinite loop)
            if (newIndex < 0) {
                newIndex = previewableItems.length - 1;
            } else if (newIndex >= previewableItems.length) {
                newIndex = 0;
            }

            openPreview(previewableItems[newIndex]);
        }

        function closeModal() {
            modal.style.display = 'none';
            modalContainer.innerHTML = '';
        }

        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        
        // Keyboard Navigation
        document.addEventListener('keydown', (e) => { 
            if (modal.style.display === 'flex') {
                if (e.key === 'Escape') closeModal();
                if (e.key === 'ArrowLeft') navigate(-1);
                if (e.key === 'ArrowRight') navigate(1);
            }
        });

        function renderBreadcrumbs() {
            breadcrumbsEl.innerHTML = "";
            const rootBtn = document.createElement("button");
            rootBtn.textContent = "Home";
            rootBtn.onclick = () => {
                while (stack.length > 0) stack.pop();
                load(null);
            };
            breadcrumbsEl.appendChild(rootBtn);

            for (let i = 0; i < stack.length; i++) {
                const sep = document.createElement("span");
                sep.textContent = " / ";
                sep.className = "sep";
                breadcrumbsEl.appendChild(sep);

                const b = document.createElement("button");
                b.textContent = stack[i].name;
                b.onclick = () => {
                    const targetLength = i + 1;
                    while (stack.length > targetLength) stack.pop();
                    load(stack[i].id);
                };
                breadcrumbsEl.appendChild(b);
            }
        }

        load(null);
    </script>
</body>

</html>